"use strict";(()=>{var F=Object.create;var v=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var G=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty;var _=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var J=(t,e,i,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of D(e))!q.call(t,n)&&n!==i&&v(t,n,{get:()=>e[n],enumerable:!(r=L(e,n))||r.enumerable});return t};var B=(t,e,i)=>(i=t!=null?F(G(t)):{},J(e||!t||!t.__esModule?v(i,"default",{value:t,enumerable:!0}):i,t));var R=_((Y,b)=>{function l(t,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(t)),this._timeouts=t,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}b.exports=l;l.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};l.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};l.prototype.retry=function(t){if(this._timeout&&clearTimeout(this._timeout),!t)return!1;var e=new Date().getTime();if(t&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(t),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(t);var i=this._timeouts.shift();if(i===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),i=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},i),this._options.unref&&this._timer.unref(),!0};l.prototype.attempt=function(t,e){this._fn=t,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var i=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){i._operationTimeoutCb()},i._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};l.prototype.try=function(t){console.log("Using RetryOperation.try() is deprecated"),this.attempt(t)};l.prototype.start=function(t){console.log("Using RetryOperation.start() is deprecated"),this.attempt(t)};l.prototype.start=l.prototype.try;l.prototype.errors=function(){return this._errors};l.prototype.attempts=function(){return this._attempts};l.prototype.mainError=function(){if(this._errors.length===0)return null;for(var t={},e=null,i=0,r=0;r<this._errors.length;r++){var n=this._errors[r],a=n.message,s=(t[a]||0)+1;t[a]=s,s>=i&&(e=n,i=s)}return e}});var w=_(h=>{var Z=R();h.operation=function(t){var e=h.timeouts(t);return new Z(e,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})};h.timeouts=function(t){if(t instanceof Array)return[].concat(t);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var i in t)e[i]=t[i];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],n=0;n<e.retries;n++)r.push(this.createTimeout(n,e));return t&&t.forever&&!r.length&&r.push(this.createTimeout(n,e)),r.sort(function(a,s){return a-s}),r};h.createTimeout=function(t,e){var i=e.randomize?Math.random()+1:1,r=Math.round(i*Math.max(e.minTimeout,1)*Math.pow(e.factor,t));return r=Math.min(r,e.maxTimeout),r};h.wrap=function(t,e,i){if(e instanceof Array&&(i=e,e=null),!i){i=[];for(var r in t)typeof t[r]=="function"&&i.push(r)}for(var n=0;n<i.length;n++){var a=i[n],s=t[a];t[a]=(function(c){var f=h.operation(e),o=Array.prototype.slice.call(arguments,1),p=o.pop();o.push(function(m){f.retry(m)||(m&&(arguments[0]=f.mainError()),p.apply(this,arguments))}),f.attempt(function(){c.apply(t,o)})}).bind(t,s),t[a].options=e}}});var E=_((tt,P)=>{P.exports=w()});var M=_((et,x)=>{var $=E();function W(t,e){function i(r,n){var a=e||{},s;"randomize"in a||(a.randomize=!0),s=$.operation(a);function u(o){n(o||new Error("Aborted"))}function c(o,p){if(o.bail){u(o);return}s.retry(o)?a.onRetry&&a.onRetry(o,p):n(s.mainError())}function f(o){var p;try{p=t(u,o)}catch(m){c(m,o);return}Promise.resolve(p).then(r).catch(function(d){c(d,o)})}s.attempt(f)}return new Promise(i)}x.exports=W});var T=B(M(),1);var I="create_multipart_upload",U="create_put_part_url",A="complete_multipart_upload";var H=1024*1024,y=8*H,S=async(t="/api/upload")=>{let e={method:"POST",body:JSON.stringify({intent:I}),headers:{"content-type":"application/json"}},i;try{i=await fetch(t,e).then(r=>r.json())}catch(r){throw r instanceof Error?r:new Error("Error on post to handler")}return i},K=async({partNumber:t,uploadId:e,handler:i="/api/upload",key:r})=>(0,T.default)(async()=>await(await fetch(i,{method:"POST",body:JSON.stringify({partNumber:t,uploadId:e,key:r,intent:U})})).text(),{retries:5}),Q=async({attempts:t=5,url:e,blob:i})=>{let r=0;return await(0,T.default)(async n=>{let a=await fetch(e,{method:"PUT",body:i});if(a.status===403){n(new Error("Unauthorized"));return}else{if(a.ok)return a;throw new Error("Unknown error")}},{retries:t,onRetry:n=>{r=r+1,n instanceof Error&&console.log("retrying #".concat(r," Put request of ").concat(e))}})},C=async t=>{let{file:e,numberOfParts:i,uploadId:r,key:n,onUploadProgress:a,handler:s}=t,u=0,c=Array.from({length:i}).map(async(f,o)=>{let p=await K({partNumber:o+1,uploadId:r,key:n,handler:s}),m=o*y,d=Math.min(m+y,e.size),g=e.slice(m,d),O=await Q({url:p,blob:g});u+=g.size;let N=u/e.size*100;a==null||a({total:e.size,loaded:u,percentage:N});let k=O.headers.get("ETag");return String(k).replaceAll('"',"")});return await Promise.all(c)},z=async t=>{let{key:e,etags:i,uploadId:r,metadata:n,handler:a="/api/upload"}=t;return await(0,T.default)(async()=>await(await fetch(a,{method:"POST",body:JSON.stringify({intent:A,contentType:n.type,size:n.size,metadata:n,uploadId:r,etags:i,key:e})})).json())};var V=t=>{let{access:e="public",handler:i,onUploadProgress:r,multipart:n}=t||{};return{upload:async(s,u)=>{let c={name:s,size:u.size,type:u.type},f=Math.ceil(u.size/y),{uploadId:o,key:p}=await S(i),m=await C({file:u,handler:i,key:p,numberOfParts:f,uploadId:o,onUploadProgress:r}),d=await z({metadata:c,key:p,uploadId:o,etags:m,handler:i});return{uploadId:o,key:p,metadata:c,url:"",access:e,completedData:d}}}};})();
//# sourceMappingURL=client.js.map
