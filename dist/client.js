"use strict";(()=>{var L=Object.create;var v=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var G=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty;var _=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var J=(e,t,i,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of D(t))!q.call(e,n)&&n!==i&&v(e,n,{get:()=>t[n],enumerable:!(r=F(t,n))||r.enumerable});return e};var B=(e,t,i)=>(i=e!=null?L(G(e)):{},J(t||!e||!e.__esModule?v(i,"default",{value:e,enumerable:!0}):i,e));var R=_((Y,b)=>{function u(e,t){typeof t=="boolean"&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}b.exports=u;u.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};u.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};u.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=new Date().getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var i=this._timeouts.shift();if(i===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),i=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},i),this._options.unref&&this._timer.unref(),!0};u.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var i=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){i._operationTimeoutCb()},i._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};u.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)};u.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)};u.prototype.start=u.prototype.try;u.prototype.errors=function(){return this._errors};u.prototype.attempts=function(){return this._attempts};u.prototype.mainError=function(){if(this._errors.length===0)return null;for(var e={},t=null,i=0,r=0;r<this._errors.length;r++){var n=this._errors[r],o=n.message,s=(e[o]||0)+1;e[o]=s,s>=i&&(t=n,i=s)}return t}});var w=_(h=>{var Z=R();h.operation=function(e){var t=h.timeouts(e);return new Z(t,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})};h.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var i in e)t[i]=e[i];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],n=0;n<t.retries;n++)r.push(this.createTimeout(n,t));return e&&e.forever&&!r.length&&r.push(this.createTimeout(n,t)),r.sort(function(o,s){return o-s}),r};h.createTimeout=function(e,t){var i=t.randomize?Math.random()+1:1,r=Math.round(i*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return r=Math.min(r,t.maxTimeout),r};h.wrap=function(e,t,i){if(t instanceof Array&&(i=t,t=null),!i){i=[];for(var r in e)typeof e[r]=="function"&&i.push(r)}for(var n=0;n<i.length;n++){var o=i[n],s=e[o];e[o]=(function(f){var l=h.operation(t),a=Array.prototype.slice.call(arguments,1),m=a.pop();a.push(function(c){l.retry(c)||(c&&(arguments[0]=l.mainError()),m.apply(this,arguments))}),l.attempt(function(){f.apply(e,a)})}).bind(e,s),e[o].options=t}}});var E=_((tt,P)=>{P.exports=w()});var M=_((et,x)=>{var $=E();function H(e,t){function i(r,n){var o=t||{},s;"randomize"in o||(o.randomize=!0),s=$.operation(o);function p(a){n(a||new Error("Aborted"))}function f(a,m){if(a.bail){p(a);return}s.retry(a)?o.onRetry&&o.onRetry(a,m):n(s.mainError())}function l(a){var m;try{m=e(p,a)}catch(c){f(c,a);return}Promise.resolve(m).then(r).catch(function(T){f(T,a)})}s.attempt(l)}return new Promise(i)}x.exports=H});var y=B(M(),1);var I="create_multipart_upload",S="create_put_part_url",U="complete_multipart_upload";var W=1024*1024,d=8*W,A=async(e="/api/upload")=>{let t={method:"POST",body:JSON.stringify({intent:I}),headers:{"content-type":"application/json"}},i;try{i=await fetch(e,t).then(r=>r.json())}catch(r){throw r instanceof Error?r:new Error("Error on post to handler")}return i},K=async({partNumber:e,uploadId:t,handler:i="/api/upload",key:r})=>(0,y.default)(async()=>await(await fetch(i,{method:"POST",body:JSON.stringify({partNumber:e,uploadId:t,key:r,intent:S})})).text(),{retries:5}),Q=async({attempts:e=5,url:t,blob:i})=>{let r=0;return await(0,y.default)(async n=>{let o=await fetch(t,{method:"PUT",body:i});if(o.status===403){n(new Error("Unauthorized"));return}else{if(o.ok)return o;throw new Error("Unknown error")}},{retries:e,onRetry:n=>{r=r+1,n instanceof Error&&console.log("retrying #".concat(r," Put request of ").concat(t))}})},C=async e=>{let{file:t,numberOfParts:i,uploadId:r,key:n,onUploadProgress:o,handler:s}=e,p=0,f=Array.from({length:i}).map(async(l,a)=>{let m=await K({partNumber:a+1,uploadId:r,key:n,handler:s}),c=a*d,T=Math.min(c+d,t.size),g=t.slice(c,T),z=await Q({url:m,blob:g});p+=g.size;let N=p/t.size*100;o==null||o({total:t.size,loaded:p,percentage:N});let k=z.headers.get("ETag");return String(k).replaceAll('"',"")});return await Promise.all(f)},O=async e=>{let{key:t,etags:i,uploadId:r,metadata:n,handler:o="/api/upload"}=e;return await(0,y.default)(async()=>await(await fetch(o,{method:"POST",body:JSON.stringify({intent:U,contentType:n.type,size:n.size,metadata:n,uploadId:r,etags:i,key:t})})).json())};var V=async(e,t,i)=>{console.log("HELLO BLISSSMO from hook \u{1F913}");let{access:r="public",handler:n,onUploadProgress:o,multipart:s}=i||{},p={name:e,size:t.size,type:t.type},f=Math.ceil(t.size/d),{uploadId:l,key:a}=await A(n),m=await C({file:t,handler:n,key:a,numberOfParts:f,uploadId:l,onUploadProgress:o}),c=await O({metadata:p,key:a,uploadId:l,etags:m,handler:n});return{uploadId:l,key:a,metadata:p,url:"",access:r,completedData:c}};})();
//# sourceMappingURL=client.js.map
